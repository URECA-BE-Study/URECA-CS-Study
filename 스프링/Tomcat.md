# Tomcat

## 1. 배경지식

### 1) Web Server

(1) 개념
- HTTP 프로토콜을 이용해 정적인 웹페이지를 보여주는 역할을 하는 서버이다. 하드웨어 측면에서 보면, 클라이언트로부터 HTTP 요청을 받아드리고 HTML 문서와 같은 웹페이지를 반환하는 컴퓨터 프로그램을 실행하는 컴퓨터라고도 할 수 있다. 
- HTTP 프로토콜 기반으로, 클라이언트의 요청을 서비스하는 기능을 가진다. 

<br>

(2) 역할
- WAS를 거치지 않고 바로 정적 컨텐츠를 제공한다.
- 동적 컨텐츠 제공을 위한 요청을 전달한다. 동적컨텐츠 요청을 WAS로 넘겨주고, WAS에서 처리한 결과를 클라이언트에게 전달한다. 

<Br>

(3) 기능
- **Reverse Proxy** : 서버와 클라이언트 사이 프록시를 두고 프록시를 통해 데이터를 주고받는다. 보안의 이유로 서버 내부 구조를 감추기 위해 사용한다. Forward Proxy는 서버에 방문하는 클라이언트의 주소를 감추고 Reverse Proxy는 클라이언트에서 서버의 주소를 감춘다.
- **로드 밸런싱** : 클라이언트의 요청에 따른 처리를 동작 중인 여러 WAS에게 적절히 분배한다. 
- **캐싱** : Reverse Proxy의 캐시를 의미한다. 서버로 찾아오는 클라이언트들이 자주, 반복적으로 요청하는 리소스들을 프록시 서버에 저장하고 제공한다. 
- **주기적인 체크** : 웹 서버에 존재하는 수많은 모듈을 사용하여 WAS가 정상적으로 동작하고 있는지 체크한다. 


> Reverse Proxy, 로드밸런싱, 캐싱의 역할을 Web Server가 담당하기에 Web Server와 WAS르 함께 이용한다.


<br>

(4) 필요성  
- 단순 정적 컨텐츠 처리를 맡으며 서버 부하 방지 및 효율적 분산처리를 수행한다. 
  
<br>

(5) 예시
- Apache, Nginx, IIS(Window 전용 Web server)

<br><br>

### 2) WAS(Web Application Server)
(1) 개념
- DB 조회 및 다양한 로직 처리를 요구하는 동적 컨텐츠를 제공하기 위해 만들어진 Application Server다.
- HTTP를 통해 컴퓨턴자 장치에 어플리케이션을 수행해주는 미들웨어이다.
- 웹 컨테이너, 서블릿 컨테이너라고도 불린다. 웹 컨테이너란 JSP, Servlet를 실행할 수 있는 소프트웨어로, 웹서버에서 JSP를 요청하면 톰캣에서는 JSP파일을 서블릿을 변환하여 컴파일을 수행하고, 서블릿 수행결과를 웹 서버에게 전달한다.  JSP 컨테이너가 탑재되어 있는 WAS는 JSP페이지를 컴파일해 동적인 페이지를 생성한다. 즉, WAS는 JSP, Servlet 구동환경을 제공한다. 

> **JSP**
- HTML 코드에 JAVA코드를 넣어 동적 웹페이지를 생성하는 웹어플리케이션 도구
- JSP가 실행되면 서블릿으로 변환되어 웹 어플리케이션 서버에서 동작되며 필요한 기능을 수행한다. 
- 위를 통해 생성된 데이터를 웹 페이지와 함께 클라이언트로 응답한다.

<br>


(2) 역할
- Web Server기능들을 구조적으로 분리해 처리하는 목적으로 제시되었다.
- 현재 WAS가 가지는 Web Server도 정적 컨텐츠를 처리하는데 성능상 큰 차이가 없다.
  
<br>

(3) 기능
- 프로그램 실행 환경과 데이터베이스 접속 기능 제공
- 여러 개의 트랜잭션 관리
- 업무를 처리하는 비즈니스 로직 수행
- Web Service 플랫폼으로서의 역할

<br>

(4) 필요성
  
- 자원의 효율적 사용 : 요청에 맞는 데이터를 DB에서 가져와 비즈니스 로직에 맞춰 그때 그때 결과를 제공한다.
  
<br>


(5) 예시
- Tomcat, Jetty, Undertow, Boss, Jeus, Web Sphere

> 위의 예시들은 자바 진영에서 사용하는 WAS로, 자바 외의 다른 진영에서는 WAS 역할을 명확히 구분해놓지 않고 있다.

  
<br>
  

(6) Web Server과 WAS의 분리 이유
- 기능 분리로 서버 부하 방지
- 물리적 분리로 보안강화
- 여러 대의 WAS 연결이 가능하므로 로드밸런싱, fail over, fail back 처리에 유리
- 여러 웹 어플리케이션 서비스 가능

  
<br><br><br>

## 2. Apache Tomcat이란?
: Tomcat이 Apache의 기능 일부를 가져와 제공해주는 형태로 Apache Tomcat으로 같이 합쳐서 부른다. 

### 1) Apache
- Apache 소프트웨어 재단에서 관리하는 HTTP Web Server
- 흔히 부르는 Apache server는 해당 재단에서 후원하는 오픈소스 커뮤니티에서 만든 http 웹 서버를 의미한다. 

<br><br>

### 2) Tomcat
(1) 개념
- Apache 재단에서 개발한 서블릿 컨테이너(WAS)
- JSP, 자바 서블릿과 같은 자바 기술을 실행하고 관리하는 데 사용

<br>

(2) 구성
- Coyote(HTTP Connector) : 클라이언트와 서버간의 통신 처리를 하고 HTTP 프로토콜을 지원하는 톰캣의 HTTP Connector 역할을 담당한다. 아파치 웹서버와 함께 정적 파일 서비스한다. 
- Catalina(Servlet Container) : JSP, Java Servlet을 호스팅하는 환경을 제공하고 서블릿의 라이프사이클을 관리하는 톰캣의 Servlet Container 역할을 담당한다. 
- Jasper(JSP Engine) : JSP 페이지를 서블릿으로 변환하고 실행하는 역할을 하는 톰캣의 JSP 엔진을 담당한다. 클라이언트가 JSP페이지에 접근하면 이를 서블릿 코드로 전환하고 컴파일 후 실행한다. 

<br>  

(3) 동작

**1. 클라이언트 -> Coyote**
- 클라이언트가 HTTP 요청을 보내면 톰캣의 Coyote 커넥터가 수신한다.

**2. Coyote -> Catalina**
- 수신된 HTTP 요청은 톰캣의 Catalina 서블릿 컨테이너로 전달된다.

**3. Catalina -> Context**
- Catalina는 요청 URL과 설정파일(ex. WEB-INF/web.xml 등)을 참고하여 어떤 Context가 해당 요청을 처리할지 결정하고, 그 Context로 요청을 전달한다.

**4. Context -> 요청 처리(서블릿/필터 등)**
- Context내에서는 요청 URL 매핑에 따라 특정 서블릿 또는 필터가 선택된다.
- 만약 요청 대상이 JSP페이지라면, Context는 JSP요청을 해당 JSP파일과 매핑된 서블릿으로 연결한다. 

**5. JSP요청 시, Jasper엔진에 의한 변환 및 컴파일**
- JSP 파일에 대한 요청인 경우, 톰캣은 먼저 해당 JSP가 이미 서블릿으로 변환되어 컴파일되어 있는지 확인한다.
- 최초 요청이거나 JSP파일이 변경된 경우 : Jasper(JSP Engine)가 JSP파일을 읽어 파싱한다. 파싱 결과를 기반으로 자바 서블릿 소스 코드를 생성한다. 생성된 자바 소스 코드를 컴파일하여 실행 가능한 서블릿 클래스(.class)를 생성한다. 그 후, 생성된 서블릿 클래스가 메모리에 로드되어 초기화되고, JSP의 역할을 대신한다.

**6. 서블릿(또는 변환된 JSP 서블릿)의 요청 처리**
- 선택된 서블릿(또는 변환된 JSP 서블릿)이 클라이언트의 요청을 처리한다.

**7. 응답 생성 및 전송**
- 서블릿이 생성한 응답 데이터는 HttpServletResponse객체에 작성된다.
- 이 응답은 다시 톰캣의 Coyote 커넥터로 전달되어, HTTP프로토콜에 맞게 포맷팅된다.
- 최종적으로, Coyote가 해당 응답을 네트워크를 통해 클라이언트로 전송한다.

<br>

(4) 특징
- Tomcat은 자바로 작성된 프로그램으로 JVM위에서 동작한다.
- 하나의 JVM에 하나의 Tomcat Instance(Server)가 하나의 프로세스로 동작한다. 

<br>

### 3) Embedded Tomcat

``외장 톰캣``

(1) 어플리케이션 실행
- 톰캣 설치 : 실제 자바로 작성된 코드와 상호작용할 서블릿 컨테이너가 필요하다.
- 톰캣 설정 파일 구성
- 톰캣 webapp 디렉토리에 빌드된 스프링 어플리케이션 war파일 포함
- 톰캣 실행

(2) 특징
- Host 설정으로 apache virtual host 설정 가능하다. Apache HTTPd에서 사용하는 Virtual Host 기능을 제공한다. Virtual host는 main host 하위에 가상의 호스트를 소프트웨어적으로 둘 수 있는 기능이다. 즉, 여러 어플리케이션을 하나의 포트로 서비스할 수 있다.

<br>

``내장 톰캣``

: Spring boot에는 톰캣이 내장되어 있다. 어플리케이션 빌드와 실행만으로 웹 어플리케이션 서비스가 가능하다. 톰캣을 설치할 필요 없이 어플리케이션을 바로 실행 가능하다. 

(1) 어플리케이션 실행
- 빌드된 스프링부트 어플리케이션 jar, war를 자바 명령어로 실행한다. 

(2) 특징
- 여러 호스트로 분기할 수 있는 기능을 사용하기 매우 복잡하다. 내장 톰캣으로 실행하는 Spring boot 어플리케이션은 그 자체가 하나의 프로그램으로 서블릿 컨테이너가 하나의 포트를 독자적으로 점유한다.
- 톰캣 구성 부분의 관심사를 분리하여 개발자가 코드 작성에 집중할 수 있다. 