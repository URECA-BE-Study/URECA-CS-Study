# 데드락 (Deadlock, 교착 상태)

## 개념
- 두 개 이상의 프로세스 또는 스레드가 **서로 자원을 점유한 채, 상대방의 자원을 기다리며 무한히 대기**하는 상태
- 한정된 자원을 여러 프로세스가 **동시에 요청하거나 점유**하면서 발생

---

## 데드락 발생 조건
> 4가지 모두 만족 시 발생

| 조건명         | 설명 |
|----------------|------|
| **1. 상호 배제** (Mutual Exclusion) | 자원은 한 번에 하나의 프로세스만 사용할 수 있음 |
| **2. 점유 대기** (Hold and Wait) | 자원을 점유한 상태에서, 다른 자원을 요청하며 대기 |
| **3. 비선점** (No Preemption) | 할당된 자원은 강제로 뺏을 수 없음 |
| **4. 순환 대기** (Circular Wait) | 프로세스들이 자원을 순환적으로 대기 |

---

## 데드락 처리 방식

### 1. 예방 (Prevention)
> 데드락 조건 중 하나를 **사전에 제거**하여 발생 방지

| 조건 제거 | 방법 | 단점 |
|-----------|------|------|
| 상호 배제 | 자원을 공유 가능하게 | 거의 불가능 |
| 점유 대기 | 자원을 모두 확보한 뒤 실행 | 자원 낭비(필요하지 않을 때에도 자원을 점유하고 있음), 비효율적 |
| 비선점 | 자원 요청 시 기존 자원 반납 | 현실적으로 어려움 |
| 순환 대기 | 자원에 순서 부여 후 순차적 요청 | 구현 복잡, 자원 낭비 |

> ✅ 현실적인 방법이 적고, 자원 낭비가 심해 실용성 낮음

---

### 2. 회피 (Avoidance)
> 데드락 발생 가능성을 고려하여 **안전한 상태(Safe state)** 유지

- **대표 알고리즘**: **은행원 알고리즘 (Banker's Algorithm)**
    - 다익스트라가 제안한 방법
    - 각 프로세스가 **최대 필요 자원량**을 미리 선언해야 함
    - 자원 할당 전 시뮬레이션을 통해 안전 여부(safe state) 확인
    - 안전 상태라면 할당, 아니면 보류

> 높은 오버헤드, 가정이 많아 실무에서 잘 사용되진 않음

---

### 3. 탐지 (Detection)
> 데드락이 **발생한 후** 이를 **탐지**

- 주기적으로 자원 상태를 검사
    - 시스템이 데드락 상태인지 확인
    - 어떤 프로세스가 데드락 상태인지 확인
- **Resource Allocation Graph (RAG)** 사용
    - 방향성 있는 이분 그래프
    - **Graph Reduction** 으로 데드락 판별
        - 주어진 RAG에서 edge를 하나씩 지워감
        - Complete reduced : 모든 edge가 제거 되었다면 데드락 X
        - Irrducible : 지울 수 없는 edge가 존재한다면 데드락 O
    - RAG는 높은 오버헤드를 가짐
        - 주기적인 검사 필요로, 검사 주기에 영향을 받음
        - 노드 수가 많은 경우 오버헤드 증가
    - 그래프에서 순환(cycle) 존재 여부로 데드락 판단

> 실시간 감시는 어려우나, 자원 낭비는 적음  
> 복구 전략이 반드시 필요함

### 데드락 회피(avoidance)와 탐지(detection)
- 데드락 회피
    - 최악의 경우를 생각
    - 데드락이 일어날 경우를 고려하여 회피
    - 데드락이 발생하지 않음

- 데드락 탐지
    - 최선의 경우를 생각
    - 현재 상태만 고려해 데드락이 발생하는가를 파악
    - 데드락이 발생할 수 있음
    - 데드락 발생 시 Recovery과정이 필요

---

### 4. 복구 (Recovery)
> 데드락 발생 후 **문제 해결**

#### 방법
1. **프로세스 종료**
    - 모두 종료 or 하나씩 종료 후 상태 검사
    - 선택 기준: 우선순위, 점유 자원량, 수행 시간 등

2. **자원 선점 (Resource Preemption)**
    - 희생 프로세스 선정 → 자원 회수 → 롤백(Checkpoint 방식)
    - **기아 현상 방지**를 위해 선점 횟수 제한 등 사용

---

## Wait-Free vs Lock-Free

> 멀티스레딩 환경에서 **공유 자원에 대한 동시 접근** 처리 기술

| 구분 | Wait-Free | Lock-Free |
|------|-----------|-----------|
| 개념 | **모든 스레드**가 **제한된 시간 내에** 진행 보장 | 항상 **최소 하나의 스레드**는 진행 가능 |
| 장점 | 무한 대기 없음, 데드락 발생 X | 구현 쉬움, 자원 접근 안전 |
| 단점 | 구현 복잡, 높은 오버헤드 | 일부 스레드 지연 가능 |
| 특징 | 모든 스레드가 항상 진행 가능 | 일부는 대기해도 최소한 하나는 반드시 진행 |

> 둘 다 데드락 방지에 효과적

---

## 정리 요약

| 처리 방식 | 시점 | 특징 | 실용성 |
|-----------|------|------|--------|
| **예방** | 사전 | 데드락 조건 제거 | 낮음 |
| **회피** | 사전 | Safe state 유지 | 낮음 |
| **탐지** | 사후 | 그래프 탐색 | 중간 |
| **복구** | 사후 | 종료 or 선점 | 중간 |

> 현실에서는 **탐지 + 복구** 방식이 **주로 사용**됨  
